<!doctype html>
<html lang="tr">
<head>
  <!-- Google Fonts: Inter (TR uyumlu, latin-ext) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap&subset=latin-ext" rel="stylesheet">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- CSP is set by server headers, NOT meta tags -->
  <title>İlan Ver</title>

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="apple-touch-icon" href="/assets/logo.png">

  <link rel="stylesheet" href="/css/styles.css?v=20250930" />
  <link rel="stylesheet" href="/css/notifications.css?v=20250930" />
  <link rel="stylesheet" href="/css/sell.css?v=20250930" />
  <script src="/js/csp-bypass.js"></script>
</head>
<body>

  <!-- HEADER -->
  <div data-include="partials/header.html"></div>

  <!-- Hero Section -->
  <section class="sell-hero">
    <div class="container">
      <div class="hero-content text-center">
        <div class="hero-icon">
          <i class="fas fa-plus-circle"></i>
        </div>
        <h1 class="hero-title">Yeni İlan Oluştur</h1>
        <p class="hero-subtitle">Ürününüzü satın veya takas için listeleyin</p>
      </div>
    </div>
  </section>

  <!-- Yeni İlan Form -->
  <section class="sell-form container">
    <form id="sellForm" class="modern-form" data-validate data-sanitize novalidate>

      <!-- Kategori Section -->
      <div class="form-section">
        <div class="section-header">
          <i class="fas fa-tags"></i>
          <h2>Kategori</h2>
        </div>
        <div class="form-grid">
          <div class="form-field">
            <label for="mainCat">Ana Kategori <span class="req">*</span></label>
            <select id="mainCat" name="category_main" required>
              <option value="">Seçiniz…</option>
              <!-- JS dolduracak -->
            </select>
            <p class="help">Önce ana kategoriyi seçin</p>
            <div class="invalid-feedback"></div>
          </div>

          <div class="form-field">
            <label for="subCat">Alt Kategori</label>
            <select id="subCat" name="category_sub" disabled>
              <option value="">Önce ana kategori</option>
            </select>
            <p class="help">Varsa alt kategori seçin</p>
            <div class="invalid-feedback"></div>
          </div>
        </div>
      </div>

      <!-- Temel Bilgiler Section -->
      <div class="form-section">
        <div class="section-header">
          <i class="fas fa-info-circle"></i>
          <h2>Temel Bilgiler</h2>
        </div>
        <div class="form-grid">
          <div class="form-field form-span-2">
            <label for="title">İlan Başlığı <span class="req">*</span></label>
            <input id="title" name="title" type="text" placeholder="Örn: iPhone 13 Pro 256GB Yeni Kutusunda" required
                   data-sanitize="text" minlength="10" maxlength="100" />
            <p class="help">Kısa ve açıklayıcı bir başlık yazın (10-100 karakter)</p>
            <div class="invalid-feedback"></div>
          </div>

          <div class="form-field form-span-2">
            <label for="desc">Açıklama</label>
            <textarea id="desc" name="description_md" rows="5"
                      placeholder="Ürününüzü detaylı bir şekilde tanıtın. Durumu, özellikleri, aksesuarları vb. hakkında bilgi verin..."
                      data-sanitize="text" maxlength="2000"></textarea>
            <div class="invalid-feedback"></div>
          </div>

          <!-- Hidden slug field - auto-generated by backend -->
          <input id="slug" name="slug" type="hidden" />
        </div>
      </div>

      <!-- Fiyat ve Durum Section -->
      <div class="form-section">
        <div class="section-header">
          <i class="fas fa-lira-sign"></i>
          <h2>Fiyat ve Durum</h2>
        </div>
        <div class="form-grid">
          <div class="form-field">
            <label for="price">Fiyat <span class="req">*</span></label>
            <div class="input-with-icon">
              <i class="fas fa-lira-sign"></i>
              <input id="price" name="price_display" type="text" inputmode="decimal"
                     placeholder="Örn: 12.499,90" required data-sanitize="price" />
              <input id="price_minor" name="price_minor" type="hidden" />
            </div>
            <p class="help">Noktayı binlik, virgülü kuruş için kullanabilirsiniz</p>
            <div class="invalid-feedback"></div>
          </div>

          <div class="form-field">
            <label for="currency">Para Birimi</label>
            <select id="currency" name="currency">
              <option value="TRY" selected>TRY (₺)</option>
              <option value="USD">USD ($)</option>
              <option value="EUR">EUR (€)</option>
            </select>
          </div>

          <div class="form-field">
            <label for="condition">Ürün Durumu</label>
            <select id="condition" name="condition_grade">
              <option value="new">🆕 Yeni (sıfır)</option>
              <option value="like_new">⭐ Çok iyi (like new)</option>
              <option value="good" selected>👍 İyi</option>
              <option value="fair">👌 Orta</option>
              <option value="poor">⚠️ Zayıf</option>
            </select>
          </div>

          <div class="form-field">
            <label for="city">Şehir</label>
            <select id="city" name="location_city">
              <option value="">📍 Şehir seçiniz</option>
              <!-- JavaScript ile doldurulacak -->
            </select>
          </div>

          <!-- İlan Durumu (sadece düzenleme modunda görünür) -->
          <div class="form-field form-span-2" id="statusField" style="display:none;">
            <label for="status">İlan Durumu</label>
            <select id="status" name="status">
              <option value="draft">Taslak</option>
              <option value="pending_review">İnceleme Bekliyor</option>
              <option value="active">Aktif</option>
              <option value="rejected">Reddedildi</option>
              <option value="paused">Pasif</option>
              <option value="sold">Satıldı</option>
            </select>
            <p class="help">İlanınızın yayın durumunu belirleyin</p>
          </div>
        </div>
      </div>

      <!-- Görseller Section -->
      <div class="form-section">
        <div class="section-header">
          <i class="fas fa-images"></i>
          <h2>Görseller</h2>
        </div>
        <div class="form-field form-span-2">
          <div id="imageUploadArea" class="modern-image-upload">
            <div class="upload-placeholder">
              <i class="fas fa-cloud-upload-alt"></i>
              <h3>Görselleri Yükleyin</h3>
              <p>Sürükle-bırak yapabilir veya tıklayarak seçebilirsiniz</p>
              <button type="button" id="uploadBtn" class="btn-upload">
                <i class="fas fa-plus"></i>
                Görsel Seç
              </button>
            </div>
            <p class="upload-info">
              <i class="fas fa-info-circle"></i>
              En fazla 10 görsel, her biri maksimum 5MB (JPG, PNG)
            </p>
          </div>

          <div id="uploadedImages" class="uploaded-images-grid">
            <!-- Yüklenen görseller buraya eklenecek -->
          </div>

          <div class="image-stats">
            <span class="stat-badge">
              <i class="fas fa-images"></i>
              <span id="imgCount">0</span> / 10 görsel
            </span>
            <span class="stat-info">
              <i class="fas fa-star"></i>
              İlk görsel kapak fotoğrafı olacak
            </span>
          </div>

          <!-- Hidden inputs for image data -->
          <textarea id="images" name="image_urls" style="display:none;"></textarea>
        </div>
      </div>

      <!-- Ek Seçenekler Section -->
      <div class="form-section">
        <div class="section-header">
          <i class="fas fa-cog"></i>
          <h2>Ek Seçenekler</h2>
        </div>
        <div class="form-field">
          <label class="modern-checkbox">
            <input type="checkbox" id="allow_trade" name="allow_trade" />
            <span class="checkmark"></span>
            <span class="checkbox-label">
              <i class="fas fa-exchange-alt"></i>
              Takasa Açık
            </span>
          </label>
          <p class="help">Ürününüzü başka bir ürünle takas etmeyi kabul ediyorsanız işaretleyin</p>
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn-primary">
          <i class="fas fa-check-circle"></i>
          İlanı Yayınla
        </button>
      </div>
    </form>
  </section>

  <!-- FOOTER -->
  <div data-include="partials/footer.html"></div>

  <!-- JS - Resilient Loading System -->
  <!-- Load core fallback functions first -->
  <script src="/js/core-loader.js?v=20250930"></script>

  <!-- Load smart dependency manager -->
  <script src="/js/dependency-manager-v2.js?v=20250930"></script>

  <!-- Page-specific scripts -->
  <script src="/js/cities-tr.js"></script>

  <script>
    // Load page-specific scripts via dependency manager
    document.addEventListener('dependenciesLoaded', () => {
      if (window.DependencyManager) {
        window.DependencyManager.loadPageScripts('sell');
      }
    });

    // Initialize page with fallback
    function initializePage() {
      if (typeof window.EssentialFunctions?.loadPartials === 'function') {
        window.EssentialFunctions.loadPartials();
      } else if (typeof includePartials === 'function') {
        includePartials();
      }
    }

    // Initialize when dependencies are loaded or fallback
    document.addEventListener('dependenciesLoaded', initializePage);

    // Fallback initialization
    setTimeout(() => {
      if (!window.dependenciesLoadedTriggered) {
        console.log('🔧 Using fallback initialization for sell page');
        initializePage();
      }
    }, 2000);
  </script>
</body>
</html>
